<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="LOHS Comedy Club — tasteful, modern joke wall." />
  <title>LOHS Comedy Club — Refined Joke Wall</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Playfair+Display:wght@500;700&display=swap" rel="stylesheet">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <style>
    :root{
      --bg-outer: #e8e8e8;
      --bg-inner: #ffffff;
      --muted: #6b6b6b;
      --text: #212121;
      --accent: #b0894b;
      --accent-2: #d6c4a1;
      --radius: 12px;
      --shadow-1: 0 6px 20px rgba(20,20,20,0.06);
      --shadow-2: 0 2px 6px rgba(20,20,20,0.06);
    }

    html, body {height: 100%; margin: 0; padding: 0;}
    body{
      margin:0;
      background: linear-gradient(180deg, var(--bg-outer) 0%, #f7f7f7 100%);
      color: var(--text);
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      display: flex;
      justify-content: center;
      padding: 48px 20px;
    }

    .container{
      width:100%;
      max-width:1024px;
      min-height: 600px;
    }

    header{
      display:flex;
      gap:20px;
      align-items:center;
      margin-bottom:36px;
      justify-content:space-between;
    }

    .brand h1{
      margin:0;
      font-family: "Playfair Display", serif;
      font-size:28px;
      color: var(--text);
      font-weight:600;
    }

    .brand p{
      margin:0;
      color:var(--muted);
      font-size:14px;
    }

    /* Controls (sort/filter) */
    .controls {
      display:flex;
      gap:12px;
      align-items:center;
    }
    .controls label { font-size:13px; color:var(--muted); }
    .sort-select {
      padding:8px 10px;
      border-radius:8px;
      background:var(--bg-inner);
      border:1px solid rgba(0,0,0,0.06);
      font-weight:600;
      cursor:pointer;
    }

    .card{
      background: var(--bg-inner);
      border-radius: var(--radius);
      box-shadow: var(--shadow-1);
      padding:40px;
    }

    .intro{
      display:flex;
      gap:24px;
      align-items:center;
      margin-bottom:24px;
    }

    .intro h2{
      margin:0;
      font-family:"Playfair Display", serif;
      font-size:22px;
      color:var(--text);
      font-weight:600;
    }

    .intro p{
      margin:6px 0 0 0;
      color:var(--muted);
      font-size:14px;
    }

    /* Form */
    form.joke-form{
      display:flex;
      flex-direction: column;
      gap:12px;
      margin-top:18px;
      margin-bottom:18px;
    }

    .field {
      display:flex;
      flex-direction:column;
      gap:8px;
      width:100%;
    }

    input[type="text"], textarea {
      width:100%;
      padding:14px 16px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,0.06);
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(248,247,246,0.95));
      font-size:15px;
      color:var(--text);
      resize: vertical;
      min-height:50px;
      box-shadow: var(--shadow-2);
      transition: all 0.18s ease;
    }

    input[type="text"]:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 8px rgba(176,137,75,0.2);
    }

    /* Agreement area */
    .agreement {
      display:flex;
      align-items:center;
      gap:12px;
      color:var(--muted);
      font-size:14px;
      margin-bottom:4px;
    }
    .agreement a {
      color:var(--text);
      text-decoration:underline;
      cursor:pointer;
      font-weight:600;
    }

    .form-actions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
    }

    button{
      font-family: "Inter", sans-serif;
      font-weight:600;
      font-size:14px;
      padding:10px 16px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      transition: all 180ms ease;
    }

    #submitBtn{
      background: var(--accent);
      color:white;
    }
    #submitBtn:hover{opacity:0.9; transform:translateY(-2px);}
    #previewBtn{
      background: var(--accent-2);
      color:#222;
    }
    #previewBtn:hover{opacity:0.9; transform:translateY(-2px);}

    /* Disabled button style */
    button:disabled{
      opacity:0.5;
      cursor:not-allowed;
      transform:none;
    }

    /* Joke list */
    .joke-list{
      margin-top:12px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .joke {
      display:flex;
      gap:16px;
      align-items:flex-start;
      padding:18px;
      border-radius:12px;
      background: linear-gradient(180deg, var(--bg-inner), #fdfcfb);
      border: 1px solid rgba(0,0,0,0.04);
      box-shadow: var(--shadow-2);
      position:relative;
      transition: transform 0.18s ease, box-shadow 0.18s ease;
    }

    .joke:hover{
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(20,20,20,0.08);
    }

    .joke::before{
      content:"";
      position:absolute;
      left:0;
      top:0;
      bottom:0;
      width:6px;
      border-top-left-radius:12px;
      border-bottom-left-radius:12px;
      background: linear-gradient(180deg, var(--accent), var(--accent-2));
    }

    .joke-content{
      flex:1;
    }

    .meta{
      display:flex;
      gap:10px;
      align-items:center;
      margin-bottom:6px;
    }

    .meta .who{
      font-weight:700;
      font-size:13px;
      color:var(--text);
    }

    .meta .time{
      font-size:12px;
      color:var(--muted);
    }

    .joke-text{
      font-size:15px;
      color:var(--text);
      line-height:1.5;
      white-space:pre-wrap;
    }

    .joke-actions{
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:flex-end;
    }

    .icon-btn {
      background:transparent;
      border:none;
      cursor:pointer;
      padding:6px 8px;
      font-size:13px;
      color:var(--muted);
      border-radius:8px;
      transition:all 160ms ease;
    }

    .icon-btn:hover{
      color:var(--text);
      background:rgba(0,0,0,0.03);
      transform:translateY(-2px);
    }

    .empty {
      padding:28px;
      border-radius:10px;
      background:linear-gradient(180deg, rgba(255,255,255,0.8), rgba(250,249,247,0.8));
      text-align:center;
      color:var(--muted);
      font-size:15px;
      border:1px dashed rgba(0,0,0,0.04);
    }

    /* Rating stars */
    .rating {
      display:flex;
      align-items:center;
      gap:8px;
      margin-top:10px;
      font-size:14px;
      color:var(--muted);
    }
    .stars {
      display:inline-flex;
      gap:6px;
      align-items:center;
    }
    .star-btn {
      background:transparent;
      border: none;
      cursor: pointer;
      font-size:18px;
      line-height:1;
      padding:4px 6px;
      border-radius:6px;
      transition: all 120ms ease;
      color: var(--muted);
    }
    .star-btn:hover { transform: translateY(-2px); color: var(--text); background: rgba(0,0,0,0.03); }
    .star-on { color: var(--accent); font-weight:700; }

    /* Modal styles (subtle, matching palette) */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background: rgba(12,12,12,0.45);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
      opacity:0;
      pointer-events:none;
      transition:opacity 160ms ease;
    }
    .modal-backdrop.open{
      opacity:1;
      pointer-events:auto;
    }
    .modal {
      width: min(820px, 94%);
      background: var(--bg-inner);
      border-radius:12px;
      padding:22px;
      box-shadow: 0 12px 40px rgba(20,20,20,0.18);
      max-height:80vh;
      overflow:auto;
    }
    .modal h3 { margin-top:0; font-family:"Playfair Display", serif; }
    .modal p { color:var(--muted); line-height:1.5; }
    .modal .modal-actions { display:flex; justify-content:flex-end; gap:10px; margin-top:16px; }
    .modal .close-btn { background:transparent; border:1px solid rgba(0,0,0,0.06); padding:8px 12px; border-radius:8px; cursor:pointer; }
    .modal .agree-btn { background: var(--accent); color:#fff; padding:8px 14px; border-radius:8px; border:none; cursor:pointer; }

    /* small helpers */
    .notice { font-size:13px; color:var(--muted); margin-bottom:10px; }
  </style>
</head>

<body>
  <div class="container">
    <header class="brand">
      <div>
        <h1>LOHS Comedy Club</h1>
        <p>Refined Joke Wall — share a moment of levity</p>
      </div>

      <div class="controls" aria-hidden="false">
        <label for="sortSelect">Sort:</label>
        <select id="sortSelect" class="sort-select" aria-label="Sort jokes">
          <option value="best">Best (top rated)</option>
          <option value="newest">Newest</option>
        </select>
      </div>
    </header>

    <main class="card" role="main" aria-labelledby="page-title">
      <div class="intro">
        <div class="title">
          <h2 id="page-title">Joke Wall — tasteful and timeless</h2>
          <p class="small">Post a short joke, aphorism, or witty line. The design favors clarity, space, and a classic palette.</p>
        </div>
      </div>

      <!-- Agreement UI: checkbox + link to modal -->
      <div class="agreement" style="margin-bottom:12px;">
        <input id="agreeCheckbox" type="checkbox" />
        <label for="agreeCheckbox" style="color:var(--muted);font-size:14px;">
          I have read and agree to the
          <a id="guidelinesBtn">Community Guidelines</a>
        </label>
      </div>

      <form class="joke-form" id="jokeForm" onsubmit="return false;">
        <div class="field">
          <label for="author">Name (optional)</label>
          <input id="author" type="text" placeholder="Your name (or leave blank for Anonymous)" maxlength="40" />
        </div>

        <div class="field">
          <label for="joke">Your Line</label>
          <textarea id="joke" placeholder="Write something short and funny…" maxlength="800"></textarea>
        </div>

        <div class="form-actions">
          <button type="button" id="previewBtn" disabled>Preview</button>
          <button type="submit" id="submitBtn" disabled>Submit</button>
        </div>
      </form>

      <div id="jokeListArea">
        <div id="jokeList" class="joke-list" aria-live="polite"></div>
      </div>
    </main>
  </div>

  <!-- Guidelines Modal -->
  <div id="guidelinesModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Community Guidelines</h3>
      <p>
        Please do not post offensive content. Submissions containing racist slurs, hate speech, threats, targeted harassment,
        sexually explicit material involving minors, or otherwise unlawful content will be removed. Repeated or severe violations
        may result in removal of content, temporary or permanent suspension of posting privileges, and, where legally required
        (for example credible threats), reporting to the appropriate authorities. By posting, you agree to follow these community standards.
      </p>

      <div class="modal-actions">
        <button class="close-btn" id="modalClose">Close</button>
        <button class="agree-btn" id="modalAgree">I agree</button>
      </div>
    </div>
  </div>

  <script>
    // -----------------------
    // Initialize Firebase
    // -----------------------
    const firebaseConfig = {
      apiKey: "AIzaSyBWNQ1vM2Ki4ReBCOrrCD8fC1iVhwlsX8",
      authDomain: "comedy-club-alpha.firebaseapp.com",
      projectId: "comedy-club-alpha",
      storageBucket: "comedy-club-alpha.firebasestorage.app",
      messagingSenderId: "251530882249",
      appId: "1:251530882249:web:4b5c1aa8e2de9273a0b118",
      measurementId: "G-JZXQ7ZXQ7M"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Replace with your admin UID (the UID you got from firebase.auth().currentUser.uid)
    const adminUID = "YOUR_UID_HERE";

    // UI elements
    const jokeListEl = document.getElementById('jokeList');
    const jokeInput = document.getElementById('joke');
    const authorInput = document.getElementById('author');
    const submitBtn = document.getElementById('submitBtn');
    const previewBtn = document.getElementById('previewBtn');
    const agreeCheckbox = document.getElementById('agreeCheckbox');
    const guidelinesBtn = document.getElementById('guidelinesBtn');
    const guidelinesModal = document.getElementById('guidelinesModal');
    const modalClose = document.getElementById('modalClose');
    const modalAgree = document.getElementById('modalAgree');
    const sortSelect = document.getElementById('sortSelect');

    // Toggle submit/preview enabled state based on checkbox
    function updateActionButtons() {
      const ok = agreeCheckbox.checked;
      submitBtn.disabled = !ok;
      previewBtn.disabled = !ok;
    }
    agreeCheckbox.addEventListener('change', updateActionButtons);

    // Modal open/close
    guidelinesBtn.addEventListener('click', () => {
      guidelinesModal.classList.add('open');
      guidelinesModal.setAttribute('aria-hidden', 'false');
    });
    modalClose.addEventListener('click', () => {
      guidelinesModal.classList.remove('open');
      guidelinesModal.setAttribute('aria-hidden', 'true');
    });
    modalAgree.addEventListener('click', () => {
      agreeCheckbox.checked = true;
      updateActionButtons();
      guidelinesModal.classList.remove('open');
      guidelinesModal.setAttribute('aria-hidden', 'true');
    });
    // close modal when clicking outside modal content
    guidelinesModal.addEventListener('click', (e) => {
      if (e.target === guidelinesModal) {
        guidelinesModal.classList.remove('open');
        guidelinesModal.setAttribute('aria-hidden', 'true');
      }
    });

    // Helpers
    function fmtTime(d){ return d.toLocaleString(undefined,{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'}); }
    function fmtAvg(avg){ return (Math.round((avg||0) * 10) / 10).toFixed(1); }

    // Keep current user UID for quick checks
    let currentUID = null;
    auth.onAuthStateChanged(user => {
      if (!user) {
        // try to sign in anonymously automatically
        auth.signInAnonymously().catch(() => {});
        currentUID = null;
      } else {
        currentUID = user.uid;
      }
      // After auth change, it's helpful to re-render stars for visible jokes.
      // The snapshot listener rebuilds the list when data changes — but auth change doesn't trigger that.
      // So re-run a quick update of star UI for existing joke elements.
      Array.from(jokeListEl.querySelectorAll('.joke')).forEach(j => {
        const id = j.dataset.id;
        const starsDiv = j.querySelector('.stars');
        const avgSpan = j.querySelector('.avg');
        if (id && starsDiv && avgSpan) updateStarsUI(id, starsDiv, avgSpan);
        // show delete button only if admin
        const del = j.querySelector('.icon-btn[aria-role="delete-btn"]');
        if (del) {
          if (currentUID && currentUID === adminUID) del.style.display = 'inline-flex';
          else del.style.display = 'none';
        }
      });
    });

    // Create a single joke DOM node
    function createJoke(entry){
      const wrap=document.createElement('article'); wrap.className='joke'; wrap.dataset.id=entry.id;
      const content=document.createElement('div'); content.className='joke-content';
      const meta=document.createElement('div'); meta.className='meta';
      const who=document.createElement('div'); who.className='who'; who.textContent=entry.author||'Anonymous';
      const time=document.createElement('div'); time.className='time'; time.textContent=fmtTime(entry.time);
      meta.appendChild(who); meta.appendChild(time);
      const text=document.createElement('div'); text.className='joke-text'; text.textContent=entry.text;
      content.appendChild(meta); content.appendChild(text);

      // Rating area
      const ratingWrap = document.createElement('div');
      ratingWrap.className = 'rating';

      const starsDiv = document.createElement('div');
      starsDiv.className = 'stars';
      // create 5 star buttons
      for (let v = 1; v <= 5; v++) {
        const sb = document.createElement('button');
        sb.className = 'star-btn';
        sb.setAttribute('aria-label', `${v} star${v>1?'s':''}`);
        sb.innerHTML = '★';
        sb.dataset.value = v;
        // click handler will attempt to rate (needs currentUID)
        sb.addEventListener('click', (e) => {
          e.preventDefault();
          // sign in anonymously if not signed in yet
          if (!currentUID) {
            auth.signInAnonymously().catch(err => { console.error('Auth failed', err); alert('Unable to authenticate for rating.'); });
            // rating will be attempted shortly after auth change — give a small delay to let currentUID be set
            setTimeout(()=> {
              if (currentUID) rateJoke(entry.id, v);
            }, 450);
            return;
          }
          rateJoke(entry.id, v);
        });
        starsDiv.appendChild(sb);
      }

      const avgSpan = document.createElement('div');
      avgSpan.className = 'avg';
      avgSpan.style.fontSize = '13px';
      avgSpan.style.color = 'var(--muted)';
      avgSpan.textContent = `${fmtAvg(entry.ratingAverage||0)} (${(entry.ratingCount || 0)} ratings)`;

      ratingWrap.appendChild(starsDiv);
      ratingWrap.appendChild(avgSpan);

      content.appendChild(ratingWrap);

      const actions=document.createElement('div'); actions.className='joke-actions';

      const del=document.createElement('button'); del.className='icon-btn'; del.setAttribute('aria-role','delete-btn'); del.innerHTML='Remove';
      // Show delete only if currentUID matches adminUID (updated after auth change too)
      if (currentUID && currentUID === adminUID) {
        del.style.display = 'inline-flex';
      } else {
        del.style.display = 'none';
      }
      del.onclick = () => {
        if (!confirm('Remove this joke?')) return;
        // attempt delete (Firestore rules will enforce server-side)
        db.collection('jokes').doc(entry.id).delete().catch(err => {
          console.error('Delete failed', err);
          alert('Delete failed: insufficient permissions or network error.');
        });
      };

      const copy=document.createElement('button'); copy.className='icon-btn'; copy.innerHTML='Copy';
      copy.onclick=()=>{ navigator.clipboard.writeText(`${entry.text} — ${entry.author||'Anonymous'}`).then(()=>{ copy.textContent='Copied'; setTimeout(()=>copy.textContent='Copy',1200); }).catch(()=>{}); };

      actions.appendChild(copy); actions.appendChild(del);
      wrap.appendChild(content); wrap.appendChild(actions);

      // After building node, set star highlights based on average and user's prior rating (if any)
      updateStarsUI(entry.id, starsDiv, avgSpan);

      return wrap;
    }

    // Update star buttons UI: highlight up to user's rating if exists; otherwise highlight by average (rounded)
    function updateStarsUI(jokeId, starsDiv, avgSpan){
      const setHighlight = (userRating, avg) => {
        const avgRounded = Math.round((avg || 0));
        Array.from(starsDiv.children).forEach(btn => {
          const v = Number(btn.dataset.value);
          btn.classList.remove('star-on');
          if (userRating != null) {
            if (v <= userRating) btn.classList.add('star-on');
          } else {
            if (v <= avgRounded) btn.classList.add('star-on');
          }
        });
      };

      // fetch joke doc to get latest average (in case not passed)
      db.collection('jokes').doc(jokeId).get().then(jd => {
        const jdData = jd.exists ? jd.data() : {};
        const avg = jdData.ratingAverage || 0;
        const count = jdData.ratingCount || 0;
        if (avgSpan) avgSpan.textContent = `${fmtAvg(avg)} (${count} ratings)`;
      }).catch(()=>{});

      if (!currentUID) {
        // no user -> highlight by average
        db.collection('jokes').doc(jokeId).get().then(jd => {
          const jdData = jd.exists ? jd.data() : {};
          setHighlight(null, jdData.ratingAverage || 0);
        }).catch(()=> setHighlight(null, 0));
        return;
      }
      // fetch user's rating doc
      db.collection('jokes').doc(jokeId).collection('ratings').doc(currentUID).get().then(rdoc => {
        if (rdoc.exists) {
          const ur = rdoc.data().rating;
          setHighlight(ur, undefined);
        } else {
          // no user rating: use average
          db.collection('jokes').doc(jokeId).get().then(jd => {
            const jdData = jd.exists ? jd.data() : {};
            setHighlight(null, jdData.ratingAverage || 0);
          }).catch(()=> setHighlight(null, 0));
        }
      }).catch(()=> {
        // fallback
        db.collection('jokes').doc(jokeId).get().then(jd => {
          const jdData = jd.exists ? jd.data() : {};
          setHighlight(null, jdData.ratingAverage || 0);
        }).catch(()=> setHighlight(null, 0));
      });
    }

    // -----------------------
    // Query subscription + migration logic
    // -----------------------
    let unsubscribeCurrent = null;
    let migrationTriggered = false;
    let activeMode = sortSelect.value || 'best'; // 'best' or 'newest'

    sortSelect.addEventListener('change', () => {
      activeMode = sortSelect.value;
      // Resubscribe depending on user selection
      if (activeMode === 'newest') subscribeTimeQuery();
      else subscribePrimaryQuery(); // best
    });

    async function migrateMissingRatingFields() {
      if (migrationTriggered) return;
      migrationTriggered = true;
      try {
        console.log('Starting migration: adding rating fields to old jokes (if any).');
        const allDocs = await db.collection('jokes').get();
        const batches = [];
        let batch = db.batch();
        let ops = 0;
        allDocs.forEach(doc => {
          const data = doc.data();
          if (data.ratingAverage === undefined || data.ratingAverage === null) {
            const ref = db.collection('jokes').doc(doc.id);
            batch.update(ref, {
              ratingSum: data.ratingSum || 0,
              ratingCount: data.ratingCount || 0,
              ratingAverage: data.ratingAverage || 0
            });
            ops++;
            if (ops >= 400) { // keep batch < 500
              batches.push(batch.commit());
              batch = db.batch();
              ops = 0;
            }
          }
        });
        if (ops > 0) batches.push(batch.commit());
        await Promise.all(batches);
        console.log('Migration complete (old docs updated). Attempting rating-order subscription again.');
        // After migration, try subscribing to rating-based query again:
        if (activeMode === 'best') subscribePrimaryQuery();
      } catch (err) {
        console.warn('Migration failed or blocked by rules:', err);
      }
    }

    function clearAndRenderSnapshot(snapshot) {
      jokeListEl.innerHTML = '';
      if (snapshot.empty) {
        const empty = document.createElement('div');
        empty.className = 'empty';
        empty.textContent = 'No entries yet — be the first to post a tasteful one-liner.';
        jokeListEl.appendChild(empty);
        return;
      }
      snapshot.forEach(doc=>{
        const data = doc.data();
        const entry = {
          id: doc.id,
          author: data.author,
          text: data.text,
          time: data.time ? data.time.toDate() : new Date(),
          ratingAverage: data.ratingAverage || 0,
          ratingCount: data.ratingCount || 0
        };
        jokeListEl.appendChild(createJoke(entry));
      });
    }

    function subscribePrimaryQuery() {
      // rating-first ordering (best)
      if (unsubscribeCurrent) { unsubscribeCurrent(); unsubscribeCurrent = null; }
      try {
        const q = db.collection("jokes").orderBy("ratingAverage","desc").orderBy("time","desc");
        unsubscribeCurrent = q.onSnapshot(snapshot => {
          clearAndRenderSnapshot(snapshot);
        }, err => {
          console.error('Primary (rating) query failed:', err);
          // If index missing or permission error, fallback to time query.
          fallbackToTimeQuery(err);
        });
      } catch (e) {
        console.error('Primary subscription error:', e);
        fallbackToTimeQuery(e);
      }
    }

    function subscribeTimeQuery() {
      if (unsubscribeCurrent) { unsubscribeCurrent(); unsubscribeCurrent = null; }
      const q = db.collection("jokes").orderBy("time","desc");
      unsubscribeCurrent = q.onSnapshot(snapshot => {
        clearAndRenderSnapshot(snapshot);
      }, err => {
        console.error('Time-order query failed:', err);
        jokeListEl.innerHTML = '';
        const empty = document.createElement('div');
        empty.className = 'empty';
        empty.textContent = 'Unable to load jokes (check console for details).';
        jokeListEl.appendChild(empty);
      });
    }

    function fallbackToTimeQuery(err) {
      console.warn('Falling back to time-ordered query because rating-based query failed or index is missing.', err);
      if (unsubscribeCurrent) { unsubscribeCurrent(); unsubscribeCurrent = null; }
      subscribeTimeQuery();
      // Trigger migration attempt so documents get rating fields added;
      // after migration we attempt to resubscribe to the primary rating query.
      migrateMissingRatingFields();
    }

    // entry point
    function renderJokes(){
      if (activeMode === 'newest') subscribeTimeQuery();
      else subscribePrimaryQuery();
    }

    // -----------------------
    // Rating transaction
    // -----------------------
    function rateJoke(jokeId, newRating){
      if (!currentUID) {
        alert('Signing you in anonymously to save your rating...');
        auth.signInAnonymously().catch(err => { console.error(err); alert('Could not sign in for rating.'); });
        return;
      }
      const jokeRef = db.collection('jokes').doc(jokeId);
      const userRatingRef = jokeRef.collection('ratings').doc(currentUID);

      db.runTransaction(async tx => {
        const [jokeSnap, userSnap] = await Promise.all([tx.get(jokeRef), tx.get(userRatingRef)]);
        if (!jokeSnap.exists) {
          throw "Joke missing";
        }
        const jd = jokeSnap.data();
        let ratingSum = jd.ratingSum || 0;
        let ratingCount = jd.ratingCount || 0;
        const prev = userSnap.exists ? (userSnap.data().rating || 0) : null;

        if (prev === null) {
          ratingSum = ratingSum + newRating;
          ratingCount = ratingCount + 1;
        } else {
          ratingSum = ratingSum - prev + newRating;
        }
        const ratingAverage = ratingCount ? (ratingSum / ratingCount) : 0;

        // set / update user's rating doc
        tx.set(userRatingRef, { rating: newRating, uid: currentUID }, { merge: true });
        // update aggregate fields on joke document
        tx.update(jokeRef, { ratingSum: ratingSum, ratingCount: ratingCount, ratingAverage: ratingAverage });
      }).then(()=> {
        // success; snapshot will reflect changes
      }).catch(err => {
        console.error('Rating transaction failed', err);
        alert('Failed to save rating. Please try again.');
      });
    }

    // Submit and preview handlers (require agreement checkbox)
    submitBtn.addEventListener('click',()=>{
      if(!agreeCheckbox.checked) { alert('Please confirm you have read the Community Guidelines.'); return; }
      const text = jokeInput.value.trim();
      if(!text) return;
      db.collection("jokes").add({
        author: authorInput.value.trim() || "Anonymous",
        text: text,
        time: firebase.firestore.FieldValue.serverTimestamp(),
        ratingSum: 0,
        ratingCount: 0,
        ratingAverage: 0
      }).then(()=> {
        // optionally reset fields
        jokeInput.value=''; authorInput.value='';
        // If user is currently viewing 'best' mode, we may need to ensure the new doc shows up (it has 0 average).
        // The snapshot listener will handle that automatically.
      }).catch(err => {
        console.error('Add failed', err);
        alert('Failed to submit. Please try again.');
      });
    });

    previewBtn.addEventListener('click',()=>{
      if(!agreeCheckbox.checked) { alert('Please confirm you have read the Community Guidelines.'); return; }
      const text = jokeInput.value.trim();
      if(!text) return;
      const entry={id:'tmp',author:authorInput.value||'You (preview)',text:text,time:new Date(), ratingAverage:0, ratingCount:0};
      const el=createJoke(entry);
      jokeListEl.insertBefore(el,jokeListEl.firstChild);
      setTimeout(()=>{ if(el.parentNode) el.remove(); },3000);
    });

    // Kick off render
    renderJokes();
    updateActionButtons(); // keep buttons disabled until user checks

    // Optional: expose currentUID for debugging (remove in production)
    window.__LOHS = { getCurrentUID: () => currentUID };
  </script>
</body>
</html>
