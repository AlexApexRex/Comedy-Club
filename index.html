<script>
  // ---------------- FIREBASE CONFIG ----------------
  const firebaseConfig = {
    apiKey: "AIzaSyBWNQ1vM2Ki4ReBCOrrCD8XfC1iVhwlsX8",
    authDomain: "comedy-club-alpha.firebaseapp.com",
    projectId: "comedy-club-alpha",
    storageBucket: "comedy-club-alpha.appspot.com",
    messagingSenderId: "251530882249",
    appId: "1:251530882249:web:4b5c1aa8e2de9273a0b118",
    measurementId: "G-JZXQ7ZXQ7M"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  const adminUID = "viFrocQunxR1y0Pma5DHihAVeWF2";

  // UI refs
  const jokeListEl = document.getElementById('jokeList');
  const jokeInput = document.getElementById('joke');
  const authorInput = document.getElementById('author');
  const submitBtn = document.getElementById('submitBtn');
  const previewBtn = document.getElementById('previewBtn');
  const agreeCheckbox = document.getElementById('agreeCheckbox');
  const sortSelect = document.getElementById('sortSelect');

  let currentUID = null;
  let unsubscribeCurrent = null;

  // ---------------- HELPERS ----------------
  function fmtTime(d){ return d.toLocaleString(undefined,{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'}); }
  function fmtAvg(avg){ return (Math.round((avg||0) * 10) / 10).toFixed(1); }

  function updateActionButtons(){
    const ready = agreeCheckbox.checked && currentUID !== null;
    submitBtn.disabled = !ready;
    previewBtn.disabled = !ready;
  }
  agreeCheckbox.addEventListener('change', updateActionButtons);

  // ---------------- ANONYMOUS AUTH ----------------
  auth.onAuthStateChanged(user => {
    if (!user) {
      auth.signInAnonymously().catch(err => console.error('Anonymous auth failed', err));
    } else {
      currentUID = user.uid;
      updateActionButtons();
      // refresh stars & admin delete buttons
      document.querySelectorAll('.joke').forEach(j => {
        const id = j.dataset.id;
        const starsDiv = j.querySelector('.stars');
        const avgSpan = j.querySelector('.avg-text');
        if (id && starsDiv && avgSpan) updateStarsUI(id, starsDiv, avgSpan);
        const del = j.querySelector('.delete-btn');
        if (del) del.style.display = (currentUID === adminUID) ? 'inline-flex' : 'none';
      });
    }
  });

  // ---------------- CREATE JOKE DOM ----------------
  function createJokeNode(entry){
    const wrap = document.createElement('article');
    wrap.className = 'joke';
    wrap.dataset.id = entry.id;

    const content = document.createElement('div');
    content.className = 'joke-content';

    const meta = document.createElement('div');
    meta.className = 'meta';
    const who = document.createElement('div'); who.className = 'who'; who.textContent = entry.author || 'Anonymous';
    const when = document.createElement('div'); when.className='time'; when.textContent = entry.time ? fmtTime(entry.time) : '';
    meta.appendChild(who); meta.appendChild(when);

    const text = document.createElement('div'); text.className='joke-text'; text.textContent = entry.text;
    content.appendChild(meta); content.appendChild(text);

    // Rating row
    const ratingRow = document.createElement('div'); ratingRow.className = 'rating-row';
    const starsDiv = document.createElement('div'); starsDiv.className='stars';
    for(let v=1; v<=5; v++){
      const sb = document.createElement('button');
      sb.className = 'star-btn';
      sb.innerText = '★';
      sb.dataset.value = v;
      sb.title = `${v} star${v>1?'s':''}`;
      sb.addEventListener('click', starClickHandler);
      starsDiv.appendChild(sb);
    }

    const avgSpan = document.createElement('div'); avgSpan.className='avg-text';
    avgSpan.textContent = `Rating: ${fmtAvg(entry.ratingAverage||0)} / 5 (${entry.ratingCount||0} votes)`;
    ratingRow.appendChild(starsDiv); ratingRow.appendChild(avgSpan);
    content.appendChild(ratingRow);

    // Actions
    const actions = document.createElement('div'); actions.className='joke-actions';
    const copyBtn = document.createElement('button'); copyBtn.className='icon-btn'; copyBtn.textContent='Copy';
    copyBtn.onclick = ()=> navigator.clipboard.writeText(`${entry.text} — ${entry.author||'Anonymous'}`).catch(()=>{});
    const delBtn = document.createElement('button'); delBtn.className='icon-btn delete-btn'; delBtn.textContent='Remove';
    delBtn.style.display = (currentUID === adminUID) ? 'inline-flex' : 'none';
    delBtn.onclick = ()=> {
      if (!confirm('Remove this joke?')) return;
      db.collection('jokes').doc(entry.id).delete().catch(err=>{ console.error('Delete failed', err); alert('Delete failed'); });
    };
    actions.appendChild(copyBtn); actions.appendChild(delBtn);

    wrap.appendChild(content); wrap.appendChild(actions);

    // Set star highlights
    updateStarsUI(entry.id, starsDiv, avgSpan);

    return wrap;
  }

  // ---------------- STAR CLICK HANDLER ----------------
  function starClickHandler(e){
    e.preventDefault();
    const sb = e.currentTarget;
    const jokeEl = sb.closest('.joke');
    if (!jokeEl) return;

    const jokeId = jokeEl.dataset.id;
    const value = Number(sb.dataset.value);

    if (!currentUID) {
      auth.signInAnonymously().then(() => {
        setTimeout(() => { if(currentUID) rateJoke(jokeId, value); }, 300);
      }).catch(err => { console.error('Anonymous login failed', err); alert('Unable to authenticate for rating.'); });
      return;
    }

    rateJoke(jokeId, value);
  }

  // ---------------- UPDATE STARS UI ----------------
  function updateStarsUI(jokeId, starsDiv, avgSpan){
    db.collection('jokes').doc(jokeId).get().then(jsnap=>{
      const jd = jsnap.exists ? jsnap.data() : {};
      const avgRounded = Math.round(jd.ratingAverage || 0);
      const count = jd.ratingCount || 0;
      avgSpan.textContent = `Rating: ${fmtAvg(jd.ratingAverage||0)} / 5 (${count} votes)`;
    }).catch(()=>{});

    if (!currentUID) return;

    db.collection('jokes').doc(jokeId).collection('ratings').doc(currentUID).get().then(rsnap=>{
      const rating = rsnap.exists ? rsnap.data().rating : null;
      const highlight = rating !== null ? rating : Math.round(rsnap.exists ? rsnap.data().ratingAverage||0 : 0);
      Array.from(starsDiv.children).forEach(btn => btn.classList.toggle('star-on', Number(btn.dataset.value) <= highlight));
    }).catch(()=>{});
  }

  // ---------------- RATE JOKE FUNCTION ----------------
  function rateJoke(jokeId, newRating){
    if (!currentUID) return;

    const jokeRef = db.collection('jokes').doc(jokeId);
    const userRef = jokeRef.collection('ratings').doc(currentUID);

    db.runTransaction(async tx => {
      const jSnap = await tx.get(jokeRef);
      if (!jSnap.exists) throw new Error('Joke does not exist.');

      const rSnap = await tx.get(userRef);
      const jd = jSnap.data();

      let ratingSum = jd.ratingSum || 0;
      let ratingCount = jd.ratingCount || 0;
      const prevRating = rSnap.exists ? (rSnap.data().rating || 0) : null;

      if(prevRating === null){ ratingSum += newRating; ratingCount += 1; }
      else { ratingSum = ratingSum - prevRating + newRating; }

      const ratingAverage = ratingCount ? (ratingSum / ratingCount) : 0;

      tx.set(userRef, { rating: newRating, uid: currentUID }, { merge:true });
      tx.update(jokeRef, { ratingSum, ratingCount, ratingAverage });
    }).then(() => {
      const starsDiv = document.querySelector(`.joke[data-id="${jokeId}"] .stars`);
      const avgSpan = document.querySelector(`.joke[data-id="${jokeId}"] .avg-text`);
      if(starsDiv && avgSpan) updateStarsUI(jokeId, starsDiv, avgSpan);
      console.log(`Rated joke ${jokeId} with ${newRating} stars`);
    }).catch(err => {
      console.error('Rating failed', err);
      alert('Unable to save your rating. Please try again.');
    });
  }

  // ---------------- SUBSCRIPTIONS ----------------
  function subscribePrimary(){
    if(unsubscribeCurrent) unsubscribeCurrent();
    try {
      const q = db.collection('jokes').orderBy('ratingAverage','desc').orderBy('time','desc');
      unsubscribeCurrent = q.onSnapshot(renderSnapshot, err => { console.warn('Primary query failed', err); subscribeTime(); });
    } catch(e){ subscribeTime(); }
  }
  function subscribeTime(){
    if(unsubscribeCurrent) unsubscribeCurrent();
    const q = db.collection('jokes').orderBy('time','desc');
    unsubscribeCurrent = q.onSnapshot(renderSnapshot, err => {
      console.error('Time query failed', err);
      jokeListEl.innerHTML = '<div class="empty">Unable to load jokes.</div>';
    });
  }

  function renderSnapshot(snapshot){
    jokeListEl.innerHTML = '';
    if(snapshot.empty){
      jokeListEl.appendChild(Object.assign(document.createElement('div'), {className:'empty', textContent:'No entries yet — be the first to post.'}));
      return;
    }
    snapshot.forEach(doc => {
      const d = doc.data();
      const entry = {
        id: doc.id,
        author: d.author,
        text: d.text,
        time: d.time ? d.time.toDate() : null,
        ratingSum: d.ratingSum||0,
        ratingCount: d.ratingCount||0,
        ratingAverage: d.ratingAverage||0
      };
      jokeListEl.appendChild(createJokeNode(entry));
    });
  }

  sortSelect.addEventListener('change', ()=>{ if(sortSelect.value==='time') subscribeTime(); else subscribePrimary(); });

  // ---------------- SUBMIT / PREVIEW ----------------
  submitBtn.addEventListener('click', async ()=>{
    if(!agreeCheckbox.checked){ alert('Please agree to the community guidelines.'); return; }
    if(!currentUID){ alert('Signing in... please wait a moment.'); return; }
    const text = jokeInput.value.trim(); if(!text) return;
    try{
      await db.collection('jokes').add({
        author: authorInput.value.trim()||'Anonymous',
        text: text,
        time: firebase.firestore.FieldValue.serverTimestamp(),
        ratingSum:0,
        ratingCount:0,
        ratingAverage:0
      });
      jokeInput.value=''; authorInput.value='';
    }catch(err){
      console.error('Add failed', err);
      alert('Failed to submit. Please try again.');
    }
  });

  previewBtn.addEventListener('click', ()=>{
    if(!agreeCheckbox.checked){ alert('Please agree to the community guidelines.'); return; }
    const text = jokeInput.value.trim(); if(!text) return;
    const tmp = { id:'tmp', author: authorInput.value||'You (preview)', text:text, time: new Date(), ratingSum:0, ratingCount:0, ratingAverage:0 };
    const el = createJokeNode(tmp);
    jokeListEl.insertBefore(el, jokeListEl.firstChild);
    setTimeout(()=>{ if(el.parentNode) el.remove(); }, 3000);
  });

  // ---------------- INITIAL SUBSCRIBE ----------------
  if(sortSelect.value==='time') subscribeTime(); else subscribePrimary();

  window.__LOHS = { getCurrentUID:()=>currentUID };
</script>
